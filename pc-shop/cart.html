<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>购物车</title>
    <link rel="shortcut icon" href="images/logo1.ico">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/cart.css">
</head>
<body>
<header>
    <div id="top">
        <a href="#">
            <img src="images/top.jpg" alt="">
        </a>
    </div>
    <nav>
        <div class="yitao-top">
            <div class="yitao-top-left">欢迎来到一淘网，阿里巴巴旗下生活省钱利器！</div>
            <ul class="right-list">
                <li class="login">
                    <a href="login.html">亲，请登录</a>|
                    <a href="register.html">免费注册</a>
                </li>
                <li><a href="index.html">首页</a></li>
                <li><a href="cart.html">购物车</a></li>
                <li><a href="order.html">我的订单</a></li>
                <li><a href="#">收藏夹</a></li>
                <li><a href="#">消息</a></li>
            </ul>
        </div>
    </nav>

    <div class="yitao-header">
        <div class="logo">
            <a href="#"><img src="images/LOGO.png" alt=""></a>
        </div>
        <div class="container-box">
            <div class="container">
                <input type="text" class="search" id="search" placeholder="购物拿返利，手机下单更便捷">
                <button class="searchGoods" id="searchGoods"><img src="images/search.png" alt=""></button>
            </div>
            <div class="container-goods">
                <ul class="container-list">
                    <li><a href="#">妈妈装</a></li>
                    <li><a href="#">女T恤短袖</a></li>
                    <li><a href="#">男外套</a></li>
                    <li><a href="#">连衣裙</a></li>
                    <li><a href="#">手机</a></li>
                    <li><a href="#">雪纺衬衫</a></li>
                    <li><a href="#">阔腿裤</a></li>
                    <li><a href="#">女鞋</a></li>
                    <li><a href="#">袜子</a></li>
                </ul>
            </div>
        </div>
        <div class="download">
        </div>
    </div>
</header>
<section>
    <div class="shop" id="Shop">
        <h1>我的购物车</h1>
        <div class="shop-list">
            <div class="shop-list-check">
                <input type="checkbox" id="selectAll">
                <i>全选</i>
            </div>
            <div class="shop-list-mas">商品信息</div>
            <div class="shop-list-one">单价（元）</div>
            <div class="shop-list-s">数量</div>
            <em>金额（元）</em>
            <span>操作</span>
        </div>
        <!-- 每一条商品信息 -->
        <!--<div class="goods">
            <div class="goods-box">
                <input type="checkbox" class="chkbox">
                <input type="hidden" class="goods_id" value="商品id">
                <img src="images/signIn.png" alt="">
                <p>商品的名字</p>
            </div>
            <div class="goods-one">价钱</div>
            <div class="goods-lists">
                <span class="left-button">-</span>
                <input type="text" class="center-text" value="1">
                <span class="right-button">+</span>
            </div>
            <div class="goods-sum">总价</div>
            <div class="goods-op">
                <span>删除</span>
            </div>
        </div> -->
    </div>
    <div class="shop-set" id="shopSet">
        <div class="shop-set-box">
            <span id="Delete">删除选中</span>
            <div class="shop-set-box-ri">
                <p class="shop-set-box-ri-1">
                    已选商品
                    <em id="Amount">0</em>
                    <span>
                        总价（不含运费）：
                        <em id="Money">￥0</em>
                    </span>
                </p>
                <a href="checkout.html" id="checkout">去结算</a>
            </div>
        </div>
    </div>

</section>
<footer>
    <div class="footer-container">
        <div class="footer-left">
            <ul>关于我们
                <li><a href="#">关于一淘</a></li>
                <li><a href="#">法律声明</a></li>
                <li><a href="#">诚聘英才</a></li>
                <li><a href="#">廉正邮箱</a></li>
            </ul>
            <ul>帮助中心
                <li><a href="#">新手指南</a></li>
                <li><a href="#">关于会员</a></li>
                <li><a href="#">关于返利</a></li>
                <li><a href="#">关于集分宝</a></li>
                <li><a href="#">关于会员特权</a></li>
                <li><a href="#">联系客服</a></li>
            </ul>
        </div>
        <div class="footer-canter">
            <h1>手机一淘</h1>
            <a href="#"><img src="images/yitao.png" alt=""></a>
        </div>
        <div class="footer-right">
            <ul>优惠地图
                <li><a href="#"></a></li>
                <li><a href="#">品牌特卖</a></li>
                <li><a href="#">限时闪购</a></li>
            </ul>
            <ul>商家合作
                <li><a href="#">报名入口</a></li>
                <li><a href="#">商家端问题</a></li>
            </ul>
        </div>
        <p>
            <a href="#">阿里巴巴集团</a><a href="#">淘宝网</a><a href="#">天猫</a><a href="#">聚划算</a>
            <a href="#">全球速卖通</a><a href="#">阿里巴巴国际交易市场</a><a href="#">1688</a><a href="#">阿里妈妈</a>
            <a href="#">阿里旅行·去啊</a><a href="#">阿里云计算</a><a href="#">YunOS</a><a href="#">阿里通信</a>
            <a href="#">万网</a><a href="#">高德</a><a href="#">优视</a><a href="#">友盟</a>
            <a href="#">酷盘</a><a href="#">虾米</a><a href="#">天天动听</a><a href="#">来往</a>
            <a href="#">钉钉</a><a href="#">11 Main</a><a href="#">支付宝</a>
        </p>
        <h6>Copyright © 2010-2017 ETAO.COM 版权所有</h6>
        <h6>增值电信业务经营许可证：浙B2-20080224</h6>
    </div>
</footer>
<script src="js/jquery-1.12.3.min.js"></script>
<script src="js/common.js"></script>
<script>

    $.ajax({
        "url":"http://h6.duchengjiu.top/shop/api_cart.php?token="+localStorage.token,
        "type":"GET",
        "dataType": "json",
        "success": function(response){
            console.log(response);

            if(response.data.length > 0){
                //循环数据
                for(var i=0;i<response.data.length;i++){
                    var obj = response.data[i];

                    var html = `<div class="goods">
										<div class="goods-box">
											<input type="checkbox" class="chkbox"/>
											<input type="hidden" class="goods_id" value=" ${ obj.goods_id } "/>
											<img src="${ obj.goods_thumb }" alt="" />
											<p>${ obj.goods_name }</p>
										</div>

										<div class="goods-one">${ obj.goods_price }</div>
										<div class="goods-lists">
											<span class="left-button">-</span>
											<input type="text" class="center-text" value="${ obj.goods_number }"/>
											<span class="right-button">+</span>
										</div>
										<div class="goods-sum">${ obj.goods_price * obj.goods_number }</div>
										<div class="goods-op">
											<span>删除</span>
										</div>
									</div>`;


                    $("#Shop").html( $("#Shop").html()+html );
                }

                //添加删除事件
                $(".goods-op").click(function(){
                    alert("成功删除该商品！");
                    var goods = this.parentNode;

                    $(goods).remove();
                    //删除数据库中，相应的内容
                    updetaCartAjax(this,0);
                });

                //加号事件
                $(".right-button").click(function(){
                    uadataCart(this,"+1");
                });
                //减号事件
                $(".left-button").click(function(){
                    uadataCart(this,"-1");
                });
                //键盘事件监听上下两个按钮
                $(".center-text").blur(function(){
                    setGoods(this);
                })

            }
        }
    });


    //选中元素删除商品信息
    $("#Delete").click(function(){
        //找到商品信息goods里面的复选框(选中状态的)
        var inputs = $(".goods input:checked");

        for(var i=0;i<inputs.length;i++){
            var goods_id = document.getElementsByClassName("goods_id")[0].value;

            var goodsL = inputs[i].parentNode.parentNode;

            goodsL.parentNode.removeChild(goodsL);

            var inpParent = inputs[i].parentNode;
            console.log(inpParent);
            //删除数据库中，相应的内容
            updetaCartAjax(inpParent,0);
        }


    });


    //全选和全不选 全局事件委托方法
    $("#Shop").click(function(event){
        if(event.target.id === "selectAll" ){
            //得到全选按钮的当前选中状态，存入变量
            var selected = event.target.checked;

            //通过类名找到所有商品的复选框的类数组
            var checkBoxs = document.getElementsByClassName("chkbox");
//		console.log(checkBoxs);
            for(var i=0;i<checkBoxs.length;i++){
                checkBoxs[i].checked = selected;
            }
            showSum();
            return;
        }

        //除了全选复选框事件
        if( event.target.type === "checkbox" ){
            showSum();
        }

    });


    //显示总价和选中商品数量
    function showSum(){
        //动态得到商品数据的类数组
        var goods = document.getElementsByClassName("goods");

        //信号量
        var sum = 0;  //金额累加器
        var num = 0;  //商品数量累加器

        for(var i =0;i<goods.length;i++){
            var goodObj = goods[i];

            if( $(goodObj).children("div:first").children("input").is(":checked") ){
                sum += parseInt( $(goodObj).children("div:eq(3)").text() );
                num += parseInt( $(goodObj).children("div:eq(2)").children("input").val() );
            }

        }

        $("#Money").text("￥"+sum);
        $("#Amount").text(num);
    }

    //上，下按钮的监听
    function stepSetGoods(obj,event){
        event.preventDefault();

        if(event.keyCode === 40){
            uadataCart(obj,"-1");
        }else if(event.keyCode === 38){
            uadataCart(obj,"+1");
        }
    }

    //设置某件商品数量
    function setGoods(obj){
        //获取输出的内容
        var num = parseInt( $(obj).val() );

        //判断商品数量的值，大于或者小于范围
        if(num < 1 || isNaN(num)){
            $(obj).val(1);
        }
        if(num > 10){
            $(obj).val(10);
        }

        uadataCart(obj,$(obj).val());
    }

    //改变购物车商品数量的业务函数
    function uadataCart(obj,num){
        //找对象
        var goods = obj.parentNode.parentNode;
        var goods_id = goods.getElementsByClassName("goods_id")[0].value;
        var goods_number = goods.getElementsByClassName("center-text")[0];
        var goods_number_value= parseInt(goods_number.value);
        var goods_price = goods.getElementsByClassName("goods-one")[0];
        var goods_price_value = parseInt(goods_price.innerText);
        var goods_sum = goods.getElementsByClassName("goods-sum")[0];

        //判断范围
        if(num === "-1" && goods_number_value <= 1){
            return;
        }
        if(num === "+1" && goods_number_value >= 10){
            return;
        }


        if( num === "-1"){
            goods_number_value--;
        }else if( num === "+1"){
            goods_number_value++;
        }else if( num > 0 ){
            goods_number_value = num;
        }else{
            goods_number_value = 1;
        }

        //当前商品的值               改变后的变量
        goods_number.value = goods_number_value;

        //算出合计金额
        var subtotal = goods_number_value * goods_price_value;

        console.log(subtotal);
        //把合计金额改变
        goods_sum.innerText = subtotal;

        //调用总金额函数
        showSum();
    }


    //通过ajax删除商品数据
    function updetaCartAjax(obj,num){
        var goods = obj.parentNode;
        var goods_id = goods.getElementsByClassName("goods_id")[0].value;
//	console.log(goods_id)


        $.ajax({
            "url":"http://h6.duchengjiu.top/shop/api_cart.php?token="+ localStorage.token,
            "type":"POST",
            "dataType": "json",
            "data": {
                "goods_id": goods_id,
                "number": num
            },
            "success": function(response){
                console.log(response);
            }
        });
    }
    //去下订单页面，到这总金额过去
    $("#checkout").click(function(){
        var sum = $("#Money").text().substr(1);

        location.href = "checkout.html?sum=" +sum;


    })


</script>
</body>
</html>